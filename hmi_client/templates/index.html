<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>pyberryplc HMI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        label, input, button { display: block; margin: 0.5rem 0; }
        #status { margin-top: 1rem; font-weight: bold; }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
        #alarm {
            display: none;
            font-size: 24px;
            font-weight: bold;
            color: red;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <h1>pyberryplc HMI</h1>

    <div id="alarm">ALARM ACTIVE!</div>
    <div id="plc_fault" style="display:none; font-size:24px; font-weight:bold; color:red;">
        PLC FAULT DETECTED!
    </div>

    <h2>Controls</h2>
    <button id="start_motion" onclick="sendButtonPress('start_motion')">Start Motion</button>
    <label>Enable System:
        <input type="checkbox" onchange="sendSwitchChange('enable_system', this.checked)">
    </label>
    <label>Speed Setpoint:
        <input type="number" id="speed_setpoint" onchange="sendAnalogInput('speed_setpoint', this.value)">
    </label>

    <div id="status">Status: Loading...</div>

    <script>
        const baseUrl = "http://" + window.location.hostname + ":8000";

        async function sendButtonPress(name) {
            try {
                const response = await fetch(baseUrl + "/set_button", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: name })
                });
                const result = await response.json();
                console.log("Button Press Sent:", result);

                const buttonElement = document.getElementById(name);
                if (buttonElement) {
                    buttonElement.disabled = true;
                    setTimeout(() => buttonElement.disabled = false, 500);
                }
            } catch (error) {
                console.error("Failed to send button press:", error);
            }
        }

        async function sendSwitchChange(name, value) {
            try {
                await fetch(baseUrl + "/set_switch", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: name, value: value })
                });
            } catch (error) {
                console.error("Failed to send switch change:", error);
            }
        }

        async function sendAnalogInput(name, value) {
            try {
                await fetch(baseUrl + "/set_analog_input", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: name, value: parseFloat(value) })
                });
            } catch (error) {
                console.error("Failed to send analog input:", error);
            }
        }

        const ws = new WebSocket("ws://" + window.location.hostname + ":8000/ws");

        ws.onopen = function() {
            console.log("[WebSocket] Connected to server");
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            document.getElementById("status").textContent = `Status: Motor Running: ${data.motor_running} | Alarm Active: ${data.alarm_active} | PLC Fault: ${data.plc_fault}`;

            const alarmDiv = document.getElementById("alarm");
            alarmDiv.style.display = data.alarm_active ? "block" : "none";

            const plcFaultDiv = document.getElementById("plc_fault");
            if (plcFaultDiv) {
                plcFaultDiv.style.display = data.plc_fault ? "block" : "none";
            }
        };

        ws.onclose = function() {
            console.log("[WebSocket] Disconnected");
        };

        ws.onerror = function(error) {
            console.error("[WebSocket] Error:", error);
        };
    </script>
</body>
</html>

